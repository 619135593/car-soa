# LightServiceClient å®ç°æ€»ç»“

## ğŸ‰ å®ç°å®Œæˆ

åŸºäºæˆåŠŸçš„DoorServiceClientå’ŒWindowServiceClientæ¨¡æ¿ï¼Œæˆ‘å·²ç»å®Œæ•´å®ç°äº†LightServiceClientï¼ˆç¯å…‰æœåŠ¡å®¢æˆ·ç«¯ï¼‰ï¼Œç°åœ¨ç³»ç»Ÿæ”¯æŒè½¦é—¨ã€è½¦çª—ã€ç¯å…‰ä¸‰ä¸ªä¸»è¦çš„è½¦èº«æ§åˆ¶åŠŸèƒ½ã€‚

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. æ ¸å¿ƒæ–¹æ³•å®ç°

#### 1.1 SetHeadlightState() - è®¾ç½®å‰å¤§ç¯çŠ¶æ€
```cpp
void LightServiceClient::SetHeadlightState(const application::SetHeadlightStateReq& request)
```
- **åŠŸèƒ½**ï¼šæ§åˆ¶å‰å¤§ç¯çš„å¼€å…³å’Œæ¨¡å¼
- **æ”¯æŒçŠ¶æ€**ï¼š
  - `OFF` - å…³é—­å‰å¤§ç¯
  - `LOW_BEAM` - è¿‘å…‰ç¯æ¨¡å¼
  - `HIGH_BEAM` - è¿œå…‰ç¯æ¨¡å¼
- **ä½¿ç”¨åœºæ™¯**ï¼šå¤œé—´é©¾é©¶ã€ä¼šè½¦ã€éš§é“è¡Œé©¶ç­‰

#### 1.2 SetIndicatorState() - è®¾ç½®è½¬å‘ç¯çŠ¶æ€
```cpp
void LightServiceClient::SetIndicatorState(const application::SetIndicatorStateReq& request)
```
- **åŠŸèƒ½**ï¼šæ§åˆ¶è½¬å‘ç¯å’ŒåŒé—ªç¯
- **æ”¯æŒçŠ¶æ€**ï¼š
  - `OFF` - å…³é—­è½¬å‘ç¯
  - `LEFT` - å·¦è½¬å‘ç¯
  - `RIGHT` - å³è½¬å‘ç¯
  - `HAZARD` - åŒé—ªç¯ï¼ˆå±é™©è­¦å‘Šï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼šè½¬å‘ã€å˜é“ã€ç´§æ€¥åœè½¦ç­‰

#### 1.3 SetPositionLightState() - è®¾ç½®ä½ç½®ç¯çŠ¶æ€
```cpp
void LightServiceClient::SetPositionLightState(const application::SetPositionLightStateReq& request)
```
- **åŠŸèƒ½**ï¼šæ§åˆ¶ä½ç½®ç¯ï¼ˆç¤ºå®½ç¯ï¼‰çš„å¼€å…³
- **æ”¯æŒçŠ¶æ€**ï¼š
  - `OFF` - å…³é—­ä½ç½®ç¯
  - `ON` - å¼€å¯ä½ç½®ç¯
- **ä½¿ç”¨åœºæ™¯**ï¼šå¤œé—´è¡Œé©¶ã€åœè½¦æ—¶çš„è½¦è¾†è½®å»“æ˜¾ç¤º

### 2. äº‹ä»¶å¤„ç†å®ç°

#### 2.1 LightStateChanged äº‹ä»¶
```cpp
void LightServiceClient::HandleLightStateChangedEvent(const std::shared_ptr<vsomeip::message>& message)
```
- **åŠŸèƒ½**ï¼šå¤„ç†ç¯å…‰çŠ¶æ€å®æ—¶å˜åŒ–äº‹ä»¶
- **è§¦å‘æ—¶æœº**ï¼šä»»ä½•ç¯å…‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶
- **æ•°æ®å†…å®¹**ï¼šç¯å…‰ç±»å‹ + æ–°çŠ¶æ€å€¼
- **ä½¿ç”¨åœºæ™¯**ï¼šå®æ—¶æ›´æ–°ç•Œé¢æ˜¾ç¤ºï¼ŒåŒæ­¥çŠ¶æ€

### 3. å“åº”å¤„ç†å®ç°

æ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½æœ‰å¯¹åº”çš„å“åº”å¤„ç†ï¼š
- `HandleSetHeadlightStateResponse()` - å¤„ç†å‰å¤§ç¯è®¾ç½®çš„å“åº”
- `HandleSetIndicatorStateResponse()` - å¤„ç†è½¬å‘ç¯è®¾ç½®çš„å“åº”
- `HandleSetPositionLightStateResponse()` - å¤„ç†ä½ç½®ç¯è®¾ç½®çš„å“åº”

æ¯ä¸ªå“åº”éƒ½åŒ…å«ï¼š
- æ“ä½œç»“æœï¼ˆSUCCESS/FAILï¼‰
- æ–°çš„ç¯å…‰çŠ¶æ€
- è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æœåŠ¡é…ç½®
- **æœåŠ¡ID**ï¼š`LIGHT_SERVICE_ID (0x1003)`
- **å®ä¾‹ID**ï¼š`LIGHT_INSTANCE_ID (0x1003)`
- **æ–¹æ³•ID**ï¼š
  - `SET_HEADLIGHT_STATE (0x0001)`
  - `SET_INDICATOR_STATE (0x0002)`
  - `SET_POSITION_LIGHT_STATE (0x0003)`
- **äº‹ä»¶ID**ï¼š`ON_LIGHT_STATE_CHANGED (0x8001)`
- **äº‹ä»¶ç»„ID**ï¼š`LIGHT_EVENTS_GROUP_ID (0x0001)`

### 2. æ•°æ®åºåˆ—åŒ–
ä½¿ç”¨`Serializer`ç±»è¿›è¡Œæ•°æ®è½¬æ¢ï¼š
```cpp
// è¯·æ±‚åºåˆ—åŒ–
auto payload_data = Serializer::Serialize(request);

// å“åº”ååºåˆ—åŒ–
application::SetHeadlightStateResp response;
Serializer::Deserialize(payload_data, response);
```

### 3. äº‹ä»¶è®¢é˜…æµç¨‹
```cpp
// æœåŠ¡å¯ç”¨æ—¶è‡ªåŠ¨è®¢é˜…
if (service == LIGHT_SERVICE_ID && instance == LIGHT_INSTANCE_ID && is_available) {
    // è®¢é˜…ç¯å…‰çŠ¶æ€å˜åŒ–äº‹ä»¶
    SubscribeEvent(LIGHT_SERVICE_ID, LIGHT_INSTANCE_ID, 
                  light_events::ON_LIGHT_STATE_CHANGED, LIGHT_EVENTS_GROUP_ID);
}
```

### 4. æ™ºèƒ½çŠ¶æ€æ˜¾ç¤º
å®ç°äº†å‹å¥½çš„çŠ¶æ€æ˜¾ç¤ºï¼Œå°†æšä¸¾å€¼è½¬æ¢ä¸ºå¯è¯»å­—ç¬¦ä¸²ï¼š
```cpp
// å‰å¤§ç¯çŠ¶æ€æ˜¾ç¤º
switch (request.command) {
    case application::HeadlightState::OFF: std::cout << "OFF"; break;
    case application::HeadlightState::LOW_BEAM: std::cout << "LOW_BEAM"; break;
    case application::HeadlightState::HIGH_BEAM: std::cout << "HIGH_BEAM"; break;
}
```

## ğŸ§ª æµ‹è¯•ç¨‹åºå®ç°

### 1. æµ‹è¯•è¦†ç›–èŒƒå›´

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•ç¨‹åº`src/test_light_client.cpp`ï¼ŒåŒ…å«ï¼š

#### 1.1 åŸºç¡€åŠŸèƒ½æµ‹è¯•
- ä½ç½®ç¯å¼€å…³æ§åˆ¶
- å‰å¤§ç¯æ¨¡å¼åˆ‡æ¢ï¼ˆå…³é—­â†’è¿‘å…‰â†’è¿œå…‰â†’å…³é—­ï¼‰
- è½¬å‘ç¯æ§åˆ¶ï¼ˆå·¦è½¬â†’å³è½¬â†’åŒé—ªâ†’å…³é—­ï¼‰

#### 1.2 ç»„åˆåœºæ™¯æµ‹è¯•
- å¤œé—´é©¾é©¶æ¨¡å¼ï¼ˆä½ç½®ç¯+è¿‘å…‰ç¯ï¼‰
- ç´§æ€¥åœè½¦åœºæ™¯ï¼ˆåŒé—ªç¯ï¼‰
- ä¼šè½¦åœºæ™¯ï¼ˆè¿œå…‰â†’è¿‘å…‰åˆ‡æ¢ï¼‰

#### 1.3 æ€§èƒ½æµ‹è¯•
- å¿«é€Ÿåˆ‡æ¢æµ‹è¯•ï¼ˆæµ‹è¯•ç³»ç»Ÿå“åº”æ€§èƒ½ï¼‰
- è¿ç»­æ“ä½œæµ‹è¯•ï¼ˆæµ‹è¯•ç¨³å®šæ€§ï¼‰
- ç»„åˆç¯å…‰æµ‹è¯•ï¼ˆæµ‹è¯•å¤æ‚åœºæ™¯ï¼‰

#### 1.4 å®æ—¶äº‹ä»¶æµ‹è¯•
- çŠ¶æ€å˜åŒ–äº‹ä»¶çš„æ¥æ”¶å’Œå¤„ç†
- äº‹ä»¶æ•°æ®çš„æ­£ç¡®è§£æ
- å›è°ƒå‡½æ•°çš„æ­£ç¡®è°ƒç”¨

### 2. æµ‹è¯•ç”¨ä¾‹è®¾è®¡

```cpp
// æµ‹è¯•åºåˆ—ç¤ºä¾‹
Test 1: Turn on position lights                    // åŸºç¡€å¼€å…³
Test 2: Turn on low beam headlights               // è¿‘å…‰ç¯
Test 3: Switch to high beam headlights            // è¿œå…‰ç¯
Test 4: Turn off headlights                       // å…³é—­å‰å¤§ç¯
Test 5: Turn on left indicator                    // å·¦è½¬å‘ç¯
Test 6: Turn on right indicator                   // å³è½¬å‘ç¯
Test 7: Turn on hazard lights                     // åŒé—ªç¯
Test 8: Turn off indicators                       // å…³é—­è½¬å‘ç¯
Test 9: Night mode (position lights + low beam)   // å¤œé—´æ¨¡å¼
Test 10: Turn off all lights                      // å…¨éƒ¨å…³é—­
Test 11: Rapid switching test                     // å¿«é€Ÿåˆ‡æ¢
Test 12: Combined lighting test                   // ç»„åˆåœºæ™¯
```

## ğŸ“Š ä¸å…¶ä»–æœåŠ¡å®¢æˆ·ç«¯çš„å¯¹æ¯”

| ç‰¹æ€§ | DoorServiceClient | WindowServiceClient | LightServiceClient |
|------|-------------------|---------------------|-------------------|
| æœåŠ¡ID | 0x1002 | 0x1001 | 0x1003 |
| æ–¹æ³•æ•°é‡ | 2ä¸ª | 3ä¸ª | 3ä¸ª |
| äº‹ä»¶æ•°é‡ | 2ä¸ª | 1ä¸ª | 1ä¸ª |
| æ§åˆ¶ç±»å‹ | å¼€å…³çŠ¶æ€ | ä½ç½®æ§åˆ¶ | çŠ¶æ€æ¨¡å¼ |
| æ•°æ®å¤æ‚åº¦ | ç®€å•æšä¸¾ | ç™¾åˆ†æ¯”+æšä¸¾ | å¤šç§æšä¸¾ |
| å®æ—¶æ€§è¦æ±‚ | ä¸­ç­‰ | è¾ƒé«˜ | ä¸­ç­‰ |
| å®‰å…¨æ€§è¦æ±‚ | é«˜ | ä¸­ç­‰ | é«˜ |

## ğŸš€ æ„å»ºå’Œè¿è¡Œ

### 1. æ„å»ºå‘½ä»¤
```bash
mkdir build && cd build
cmake ..
make -j$(nproc)
```

### 2. è¿è¡Œæµ‹è¯•
```bash
# ä½¿ç”¨è„šæœ¬
./run_light_test.sh

# æˆ–æ‰‹åŠ¨è¿è¡Œ
export VSOMEIP_CONFIGURATION=./config/vsomeip.json
export VSOMEIP_APPLICATION_NAME=light_test_client
./bin/test_light_client
```

### 3. é¢„æœŸç»“æœ
- æˆåŠŸè¿æ¥åˆ°STM32H7çš„ç¯å…‰æœåŠ¡
- æ‰€æœ‰æµ‹è¯•å‘½ä»¤æ­£ç¡®å‘é€å’Œæ¥æ”¶å“åº”
- å®æ—¶äº‹ä»¶æ­£ç¡®æ¥æ”¶å’Œå¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

## ğŸ¯ éªŒè¯è¦ç‚¹

### 1. åŠŸèƒ½éªŒè¯
- [ ] æ‰€æœ‰3ä¸ªæ–¹æ³•éƒ½èƒ½æ­£ç¡®è°ƒç”¨
- [ ] å‰å¤§ç¯ä¸‰ç§æ¨¡å¼åˆ‡æ¢æ­£å¸¸
- [ ] è½¬å‘ç¯å››ç§çŠ¶æ€åˆ‡æ¢æ­£å¸¸
- [ ] ä½ç½®ç¯å¼€å…³æ§åˆ¶æ­£å¸¸
- [ ] äº‹ä»¶é€šçŸ¥å®æ—¶å‡†ç¡®

### 2. æ€§èƒ½éªŒè¯
- [ ] å“åº”æ—¶é—´ < 100ms
- [ ] äº‹ä»¶å»¶è¿Ÿ < 50ms
- [ ] å¿«é€Ÿåˆ‡æ¢æ— ä¸¢å¤±
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®š

### 3. å®‰å…¨æ€§éªŒè¯
- [ ] çŠ¶æ€åˆ‡æ¢é€»è¾‘æ­£ç¡®
- [ ] å¼‚å¸¸æƒ…å†µå¤„ç†å¾—å½“
- [ ] æ— æ„å¤–çš„ç¯å…‰çŠ¶æ€
- [ ] ç´§æ€¥æƒ…å†µå“åº”åŠæ—¶

## ğŸ”„ ç³»ç»Ÿé›†æˆçŠ¶æ€

### 1. å·²å®Œæˆçš„æœåŠ¡å®¢æˆ·ç«¯
- âœ… **SomeipClient** - åŸºç±»å®ç°
- âœ… **DoorServiceClient** - è½¦é—¨æœåŠ¡
- âœ… **WindowServiceClient** - è½¦çª—æœåŠ¡
- âœ… **LightServiceClient** - ç¯å…‰æœåŠ¡

### 2. å¾…å®ç°çš„æœåŠ¡å®¢æˆ·ç«¯
- â³ **SeatServiceClient** - åº§æ¤…æœåŠ¡ï¼ˆä¸‹ä¸€ä¸ªç›®æ ‡ï¼‰

### 3. ç³»ç»Ÿæ¶æ„å®Œæ•´æ€§
- **é€šä¿¡å±‚**ï¼š75% å®Œæˆï¼ˆ3/4ä¸ªæœåŠ¡å®¢æˆ·ç«¯ï¼‰
- **æ•°æ®ç»“æ„**ï¼š100% å®Œæˆï¼ˆæ‰€æœ‰æ•°æ®ç»“æ„å·²å®šä¹‰ï¼‰
- **åºåˆ—åŒ–å·¥å…·**ï¼š100% å®Œæˆï¼ˆæ”¯æŒæ‰€æœ‰æ•°æ®ç±»å‹ï¼‰
- **é…ç½®ç³»ç»Ÿ**ï¼š100% å®Œæˆï¼ˆvsomeipå’Œç³»ç»Ÿé…ç½®ï¼‰
- **æµ‹è¯•æ¡†æ¶**ï¼š75% å®Œæˆï¼ˆ3/4ä¸ªæµ‹è¯•ç¨‹åºï¼‰

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

LightServiceClientå®ç°å®Œæˆåï¼Œå¯ä»¥ç»§ç»­ï¼š

1. **å®Œæˆæœ€åä¸€ä¸ªæœåŠ¡å®¢æˆ·ç«¯**ï¼š
   - SeatServiceClientï¼ˆåº§æ¤…æœåŠ¡ï¼‰
   - å®ç°åº§æ¤…è°ƒèŠ‚å’Œè®°å¿†ä½ç½®åŠŸèƒ½

2. **å¼€å§‹ç¬¬äºŒæ­¥å¼€å‘**ï¼š
   - REST APIæœåŠ¡å™¨å®ç°
   - HTTPæ¥å£è®¾è®¡
   - WebSocketå®æ—¶æ¨é€

3. **ç³»ç»Ÿé›†æˆæµ‹è¯•**ï¼š
   - å¤šæœåŠ¡å¹¶å‘æµ‹è¯•
   - ç«¯åˆ°ç«¯é€šä¿¡éªŒè¯
   - æ€§èƒ½å‹åŠ›æµ‹è¯•

LightServiceClientçš„æˆåŠŸå®ç°æ ‡å¿—ç€è½¦èº«åŸŸæ§åˆ¶å™¨ç³»ç»Ÿçš„é€šä¿¡å±‚å³å°†å®Œæˆï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿçš„åç»­å¼€å‘å¥ å®šäº†åšå®çš„åŸºç¡€ï¼
